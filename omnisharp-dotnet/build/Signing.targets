<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- Targets to handle assemblies using a pfx certificate.
    
       Usage:
       The following properties should be set by the caller:
       * $(PFX_PATH)      : full path to the pfx file
       * $(PFX_PASSWORD)  : password to the certificate file
       * $(PFX_SHA1)      : the sha1 for the certificate file
  -->

  <!-- Signs the output assembly for the current project -->
  <Target Name="SignOutputAssembly" AfterTargets="Build">
    <Message Condition=" $(SignArtifacts) != 'true' " Importance="high" Text="Skipping signing assemblies - SignArtifacts = '$(SignArtifacts)'" />
    <CallTarget Condition=" $(SignArtifacts) == 'true' " Targets="LocateOutputAssembly;SignAssemblies" />
  </Target>

  <Target Name="LocateOutputAssembly">
    <ItemGroup>
      <AssembliesToSign Include="$(TargetPath)" />
    </ItemGroup>
  </Target>
  
  <Target Name="SignAssemblies">
    <Message Importance="high" Text="Assembly to sign: %(AssembliesToSign.FullPath)" />
    <CallTarget Targets="ValidateCommonSigningInputs" />
    <Error Condition=" @(AssembliesToSign) == '' " Text="The list of assemblies to sign is empty." />
    <Error Condition=" $(SIGNTOOL_PATH) == '' " Text="The location of the signtool.exe has not been set ('SIGNTOOL_PATH')" />
    <Error Condition=" !Exists($(SIGNTOOL_PATH)) " Text="Signing tool exe does not exist at the specified location: $(SIGNTOOL_PATH)" />

    <Exec Command="&quot;$(SIGNTOOL_PATH)&quot; sign /fd SHA256 /sha1 $(PFX_SHA1) /f &quot;$(PFX_PATH)&quot; /p $(PFX_PASSWORD) /tr http://timestamp.digicert.com?alg=sha256 &quot;%(AssembliesToSign.FullPath)&quot;" />
  </Target>

  <Target Name="ValidateCommonSigningInputs">
    <Error Condition=" $(PFX_PATH) == '' " Text="PFX_PATH has not been set" />
    <Error Condition=" $(PFX_PASSWORD) == '' " Text="PFX_PASSWORD has not been set" />
    <Error Condition=" $(PFX_SHA1) == '' " Text="PFX_SHA1 has not been set" />
    <Error Condition=" !Exists($(PFX_PATH)) " Text="The specified pfx file does not exist: $(PFX_PATH)" />
  </Target>

</Project>